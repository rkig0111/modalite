from asyncio import run, Queue, create_task
from aioping import ping
from time import perf_counter

async def ping_host(host, taskQueue, resultsQueue, timeout, retry):
    try:
        delay = await ping(host, timeout)
        await resultsQueue.put([True, host, delay])
    except TimeoutError:
        if retry:
            try:
                delay = await ping(host, timeout)
                await resultsQueue.put([True, host, delay])
            except: await resultsQueue.put([False, host, f"{host} timed out (retried)."])
        else: await resultsQueue.put([False, host, f"{host} timed out."])
    except OSError : 
        await resultsQueue.put([False, host, f"{host} r√©seau non joignable."])      
    taskQueue.task_done()
    taskQueue.get_nowait()

async def ping_hosts(hosts, timeout=1, retry=False):
    # hosts = [["host1.com"], ["host2.com"], [...]]
    results: list = []
    taskQueue: Queue = Queue(maxsize=250)
    resultsQueue: Queue = Queue()
    for host in hosts:
        await taskQueue.put(create_task(ping_host(host[0], taskQueue, resultsQueue, timeout, retry)))
    await taskQueue.join()
    while not resultsQueue.empty():
        results.append(await resultsQueue.get())
        resultsQueue.task_done()
    await resultsQueue.join()
    return(results)

async def main(listip):
    script_start: float = perf_counter()
    '''hosts: list = [["10.126.18.10"], ["10.126.18.11"], ["10.131.5.172"], ["10.145.5.15"], ["10.145.5.30"], ["10.19.5.60"], ["10.200.4.234"], ["10.200.4.55"], ["10.208.36.10"], ["10.208.36.100"], ["10.208.36.101"], ["10.208.36.102"], ["10.208.36.103"], ["10.208.36.104"], ["10.208.36.105"], ["10.208.36.106"], ["10.208.36.107"], ["10.208.36.108"], ["10.208.36.109"], ["10.208.36.11"], ["10.208.36.110"], ["10.208.36.12"], ["10.208.36.13"], ["10.208.36.14"], ["10.208.36.15"], ["10.208.36.16"], ["10.208.36.17"], ["10.208.36.30"], ["10.208.36.32"], ["10.208.36.33"], ["10.208.36.34"], ["10.208.36.35"], ["10.208.36.36"], ["10.208.36.37"], ["10.208.36.40"], ["10.208.36.41"], ["10.208.36.42"], ["10.208.36.43"], ["10.208.36.44"], ["10.208.36.45"], ["10.208.36.46"], ["10.208.36.47"], ["10.208.36.48"], ["10.208.36.49"], ["10.208.36.50"], ["10.208.36.51"], ["10.208.36.52"], ["10.208.36.53"], ["10.208.36.54"], ["10.208.36.56"], ["10.208.36.57"], ["10.208.36.58"], ["10.208.36.59"], ["10.208.36.60"], ["10.208.36.61"], ["10.208.36.62"], ["10.208.36.63"], ["10.208.36.64"], ["10.208.36.65"], ["10.208.36.66"], ["10.208.36.67"], ["10.208.36.68"], ["10.208.36.69"], ["10.208.36.70"], ["10.208.36.71"], ["10.208.36.72"], ["10.208.36.73"], ["10.208.36.74"], ["10.208.36.75"], ["10.208.36.76"], ["10.208.36.77"], ["10.208.36.78"], ["10.208.36.79"], ["10.208.36.80"], ["10.208.36.81"], ["10.208.36.82"], ["10.208.36.83"], ["10.208.36.84"], ["10.208.36.85"], ["10.208.36.86"], ["10.208.36.87"], ["10.208.36.88"], ["10.208.36.89"], ["10.208.36.90"], ["10.208.36.91"], ["10.208.36.92"], ["10.208.36.93"], ["10.208.36.94"], ["10.208.36.95"], ["10.208.36.96"], ["10.208.36.97"], ["10.208.36.98"], ["10.208.36.99"], ["10.208.37.100"], ["10.208.37.101"],
    ["10.208.37.30"], ["10.208.37.31"], ["10.208.37.32"], ["10.208.37.33"], ["10.208.37.34"], ["10.208.37.35"], ["10.208.37.36"], ["10.208.37.37"], ["10.208.37.38"], ["10.208.37.39"], ["10.208.37.40"], ["10.208.37.41"], ["10.208.37.42"], ["10.208.37.43"], ["10.208.37.44"], ["10.208.37.46"], ["10.208.37.47"], ["10.208.37.48"], ["10.208.37.49"], ["10.208.37.50"], ["10.208.37.51"], ["10.208.37.52"], ["10.208.37.53"], ["10.208.37.54"], ["10.208.37.55"], ["10.208.37.56"], ["10.208.37.57"], ["10.208.37.58"], ["10.208.37.59"], ["10.208.37.60"], ["10.208.37.61"], ["10.208.37.62"], ["10.208.37.63"], ["10.208.37.64"], ["10.208.37.65"], ["10.208.37.66"], ["10.208.37.67"], ["10.208.37.68"], ["10.208.37.69"], ["10.208.37.70"], ["10.208.37.71"], ["10.208.37.72"], ["10.208.37.73"], ["10.208.37.80"], ["10.208.37.81"], ["10.208.37.82"], ["10.208.37.83"], ["10.208.37.84"], ["10.208.37.85"], ["10.208.37.86"], ["10.208.37.87"], ["10.208.37.88"], ["10.208.37.89"], ["10.208.37.91"], ["10.208.37.92"], ["10.208.37.93"], ["10.208.37.94"], ["10.208.37.95"], ["10.208.37.96"], ["10.208.37.97"], ["10.208.37.98"], ["10.208.37.99"], ["10.208.38.10"], ["10.208.38.11"], ["10.208.38.12"], ["10.208.38.13"], ["10.208.38.14"], ["10.208.38.15"], ["10.208.38.16"], ["10.208.38.17"], ["10.208.38.18"], ["10.208.38.19"], ["10.208.38.20"], ["10.208.38.21"], ["10.208.38.22"], ["10.208.38.23"], ["10.208.38.24"], ["10.208.38.25"], ["10.208.38.26"], ["10.208.38.27"], ["10.208.38.28"], ["10.208.38.29"], ["10.208.38.30"], ["10.208.38.31"], ["10.208.40.11"], ["10.208.40.12"], ["10.208.40.13"], ["10.208.40.14"], ["10.208.40.15"], ["10.208.40.16"], ["10.208.40.17"], ["10.208.40.18"], ["10.208.40.19"], ["10.208.40.20"], ["10.208.40.21"], ["10.208.40.22"], ["10.208.40.23"], ["10.208.40.24"], ["10.208.40.25"], ["10.208.40.26"], ["10.208.40.27"], ["10.208.40.28"], ["10.208.40.29"], ["10.208.40.30"],]'''

    hosts: list = listip
    test: list = await ping_hosts(hosts)
    # print("len(hosts) : ", len(hosts))
    # print(test)
    # print(f"Script has finished. It took {round(perf_counter()-script_start, 2)} seconds to run.")
    return test

if __name__ == "__main__":
    run(main())